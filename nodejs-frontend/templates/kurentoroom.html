<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <base href="/chatforyou/">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- External libraries (keeping original functionality) -->
    <script src="https://code.jquery.com/jquery-3.6.1.min.js" 
            integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@300;400;500;600&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- WebRTC and other original scripts -->
    <script src="https://cdn.WebRTC-Experiment.com/getScreenId.js"></script>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>
    <script src="https://cdn.rawgit.com/kimmobrunfeldt/progressbar.js/0.5.6/dist/progressbar.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.js"></script>
    
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <!-- Original CSS files (keeping backend compatibility) -->
    <link rel="styleSheet" href="css/rtc/kurentostyle.css" type="text/css" media="screen">
    <link rel="styleSheet" href="css/rtc/floating_chat.css" type="text/css" media="screen">
    <link rel="styleSheet" href="css/rtc/media_device.css" type="text/css" media="screen">
    <link rel="styleSheet" href="css/rtc/catch_mind.css" type="text/css" media="screen">
    <link rel="styleSheet" href="css/rtc/subtitle.css" type="text/css" media="screen">
    <link rel="stylesheet" href="static/css/chatroom/common.css">
    <link rel="stylesheet" href="css/common/spin.css" type="text/css" media="screen">

    <style>
        /* WhatsApp-inspired CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }

        .whatsapp-container {
            display: flex;
            height: 100vh;
            background: #111b21;
        }

        /* Sidebar - Chat List */
        .chat-sidebar {
            width: 30%;
            min-width: 320px;
            background: #0b141a;
            border-right: 1px solid #2a3942;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            background: #202c33;
            height: 59px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            border-bottom: 1px solid #2a3942;
        }

        .sidebar-title {
            color: #e9edef;
            font-size: 19px;
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            gap: 20px;
        }

        .header-action-btn {
            background: none;
            border: none;
            color: #aebac1;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .header-action-btn:hover {
            background: #2a3942;
            color: #e9edef;
        }

        .search-container {
            padding: 12px 16px;
            background: #0b141a;
            border-bottom: 1px solid #2a3942;
        }

        .search-box {
            background: #202c33;
            border: none;
            border-radius: 8px;
            padding: 12px 48px 12px 16px;
            color: #e9edef;
            width: 100%;
            font-size: 15px;
        }

        .search-box::placeholder {
            color: #8696a0;
        }

        .search-icon {
            position: absolute;
            right: 28px;
            top: 50%;
            transform: translateY(-50%);
            color: #8696a0;
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            background: #0b141a;
        }

        .chat-item {
            padding: 12px 16px;
            border-bottom: 1px solid #1f2937;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-item:hover {
            background: #202c33;
        }

        .chat-item.active {
            background: #2a3942;
        }

        .chat-avatar {
            width: 49px;
            height: 49px;
            border-radius: 50%;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
            flex-shrink: 0;
        }

        .chat-info {
            flex: 1;
            overflow: hidden;
        }

        .chat-name {
            color: #e9edef;
            font-size: 17px;
            font-weight: 400;
            margin-bottom: 2px;
        }

        .chat-preview {
            color: #8696a0;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-time {
            color: #8696a0;
            font-size: 12px;
        }

        /* Main Chat Area */
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0b141a;
        }

        .chat-header {
            background: #202c33;
            height: 59px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            border-bottom: 1px solid #2a3942;
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
        }

        .chat-header-details h3 {
            color: #e9edef;
            font-size: 16px;
            font-weight: 400;
            margin: 0;
        }

        .chat-header-details p {
            color: #8696a0;
            font-size: 13px;
            margin: 0;
        }

        .chat-actions {
            display: flex;
            gap: 20px;
        }

        .video-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .video-btn {
            background: #00a884;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .video-btn:hover {
            background: #008669;
        }

        .video-btn.active {
            background: #d62d20;
        }

        /* Video Area */
        .video-area {
            flex: 1;
            background: #0f1419;
            position: relative;
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
            gap: 10px;
            overflow-y: auto;
        }

        .video-participant {
            background: #1a252f;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            min-width: 200px;
            min-height: 150px;
            flex: 1;
        }

        .video-participant video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .participant-name {
            position: absolute;
            bottom: 8px;
            left: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        /* Chat Input Area */
        .chat-input-area {
            background: #202c33;
            padding: 12px 16px;
            border-top: 1px solid #2a3942;
        }

        .input-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-actions {
            display: flex;
            gap: 8px;
        }

        .input-btn {
            background: none;
            border: none;
            color: #8696a0;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .input-btn:hover {
            color: #e9edef;
            background: #2a3942;
        }

        .message-input {
            flex: 1;
            background: #2a3942;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            color: #e9edef;
            font-size: 15px;
            resize: none;
            min-height: 20px;
            max-height: 100px;
        }

        .message-input::placeholder {
            color: #8696a0;
        }

        .send-btn {
            background: #00a884;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .send-btn:hover {
            background: #008669;
        }

        /* Game Controls */
        .game-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .game-btn {
            background: #00a884;
            border: none;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
        }

        .game-btn:hover {
            background: #008669;
            transform: scale(1.1);
        }

        /* Status indicators */
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            position: absolute;
            bottom: 2px;
            right: 2px;
            border: 2px solid #202c33;
        }

        .status-online {
            background: #00a884;
        }

        .status-offline {
            background: #8696a0;
        }

        /* Hide original floating elements */
        .floating-chat,
        .floating-game-canvas {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .chat-sidebar {
                width: 100%;
                position: absolute;
                z-index: 10;
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            
            .chat-sidebar.active {
                transform: translateX(0);
            }
        }
    </style>
</head>

<body>
    <!-- Hidden inputs for backend compatibility -->
    <input type="hidden" id="roomId" th:value="${roomId}">
    <input type="hidden" id="uuid" th:value="${uuid}">
    <input type="hidden" id="nickName" th:value="${nickName}">
    <input type="hidden" id="roomName" th:value="${roomName}">

    <div class="whatsapp-container">
        <!-- Left Sidebar - Chat List -->
        <div class="chat-sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">ConvoSync</div>
                <div class="header-actions">
                    <button class="header-action-btn" id="screenShareBtn" data-flag="false" title="Screen Share">
                        <i class="fas fa-desktop"></i>
                    </button>
                    <button class="header-action-btn" id="userSetting" data-toggle="modal" data-target="#userSettingsModal" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>

            <div class="search-container" style="position: relative;">
                <input type="text" class="search-box" placeholder="Search or start new chat">
                <i class="fas fa-search search-icon"></i>
            </div>

            <div class="chat-list" id="participantsList">
                <div class="chat-item active">
                    <div class="chat-avatar">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="chat-info">
                        <div class="chat-name" id="room-header">Room Chat</div>
                        <div class="chat-preview">Welcome to ConvoSync!</div>
                    </div>
                    <div class="chat-time">now</div>
                    <div class="status-indicator status-online"></div>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-chat">
            <div class="chat-header">
                <div class="chat-header-info">
                    <div class="chat-header-avatar">
                        <i class="fas fa-video"></i>
                    </div>
                    <div class="chat-header-details">
                        <h3 id="roomName" th:text="${roomName}">ConvoSync Room</h3>
                        <p id="participantCount">Click to join video call</p>
                    </div>
                </div>
                <div class="chat-actions">
                    <div class="video-controls">
                        <button class="video-btn localVideoToggle" id="videoBtn" data-flag="true" title="Toggle Video">
                            <i class="fas fa-video"></i>
                        </button>
                        <button class="video-btn localAudioToggle" id="audioBtn" data-flag="true" title="Toggle Audio">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button class="video-btn" id="subtitleBtn" data-flag="false" title="Subtitles">
                            <i class="fas fa-closed-captioning"></i>
                        </button>
                        <button class="video-btn" id="button-leave" title="Leave Room">
                            <i class="fas fa-phone-slash"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Video Area -->
            <div class="video-area" id="participants">
                <!-- Video participants will be added here dynamically -->
            </div>

            <!-- Audio Device Dropdowns (hidden but functional) -->
            <div style="display: none;">
                <div id="output_dropDownContainer">
                    <span id="output_displayText"></span>
                    <div id="output_dropDownPosition">
                        <div id="output_dropDown"></div>
                    </div>
                </div>
                <div id="input_dropDownContainer">
                    <span id="input_displayText"></span>
                    <div id="input_dropDownPosition">
                        <div id="input_dropDown"></div>
                    </div>
                </div>
            </div>

            <!-- Chat Input Area -->
            <div class="chat-input-area">
                <div class="input-container">
                    <div class="input-actions">
                        <button class="input-btn" id="uploadFile" title="Attach File">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <input type="file" id="file" style="display: none;"/>
                    </div>
                    <textarea class="message-input" id="messageInput" placeholder="Type a message" rows="1"></textarea>
                    <button class="send-btn" id="sendMessage" title="Send Message">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Controls -->
    <div class="game-controls">
        <button class="game-btn" data-toggle="modal" data-target="#subjectModal" title="Start Game">
            <i class="fas fa-gamepad"></i>
        </button>
    </div>

    <!-- Original hidden elements for backend compatibility -->
    <div id="container" style="display: none;">
        <div id="wrapper">
            <div id="room">
                <div class="messages" style="display: none;"></div>
                <div class="text-box" contenteditable="true" disabled="true" style="display: none;"></div>
            </div>
        </div>
    </div>

    <div class="volume-control" type="hidden">
        <input type="hidden" id="volumeControl" min="0" max="1" step="0.01" value="0.5"/>
    </div>

    <!-- All original modals (keeping for backend compatibility) -->
    <!-- User Settings Modal -->
    <div class="modal fade" id="userSettingsModal" tabindex="-1" role="dialog" aria-labelledby="userSettingsModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content" style="background: #202c33; color: #e9edef;">
                <div class="modal-header" style="border-bottom: 1px solid #2a3942;">
                    <h5 class="modal-title" id="userSettingsModalLabel">ConvoSync Settings</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: #e9edef;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <ul id="participantsListModal" class="list-group"></ul>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #2a3942;">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
       </div>
    </div>

    <!-- Connection Fail Modal -->
    <div class="modal" tabindex="-1" role="dialog" id="connectionFailModal">
        <div class="modal-dialog" role="document">
            <div class="modal-content" style="background: #202c33; color: #e9edef;">
                <div class="modal-header" style="border-bottom: 1px solid #2a3942;">
                    <h5 class="modal-title">Connection Failed</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: #e9edef;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Connection to server was unstable and has been terminated.<br>
                        Please rejoin the room to reconnect.</p>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #2a3942;">
                    <button type="button" class="btn btn-primary" id="reconnectButton">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CatchMind Canvas Modal -->
    <div id="catchMindCanvas" class="modal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content" style="background: #202c33; color: #e9edef;">
                <div class="modal-header" style="border-bottom: 1px solid #2a3942;">
                    <h5 class="modal-title" id="roundSubject">ConvoSync Game</h5>
                    <div class="status-bar">
                        <div id="progress-container" style="height: 20px;"></div>
                        <span id="maxClearCount"></span>
                    </div>
                    <div>
                        <button type="button" id="clearCanvasBtn" class="btn btn-warning">Clear Canvas</button>
                        <button type="button" id="answerBtn" class="btn btn-success"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <canvas id="mycanvas" width="800" height="600" style="width: 100%; height: 100%;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Subject Modal -->
    <div class="modal fade" id="subjectModal" tabindex="-1" role="dialog" aria-labelledby="subjectModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog" role="document">
            <div class="modal-content" style="background: #202c33; color: #e9edef;">
                <div class="modal-header" style="border-bottom: 1px solid #2a3942;">
                    <h5 class="modal-title" id="subjectModalLabel">ConvoSync Game Setup</h5>
                </div>
                
                <ul class="nav nav-tabs" id="myTab" role="tablist" style="background: #2a3942;">
                    <li class="nav-item">
                        <a class="nav-link active" id="gameSubject-tab" data-toggle="tab" href="#gameSubject" role="tab" aria-controls="gameSubject" aria-selected="true" style="color: #e9edef;">Subject Selection</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="gameTip-tab" data-toggle="tab" href="#gameTip" role="tab" aria-controls="gameTip" aria-selected="false" style="color: #8696a0;">Game Tips</a>
                    </li>
                </ul>

                <div class="tab-content" id="myTabContent">
                    <div class="tab-pane fade show active" id="gameSubject" role="tabpanel" aria-labelledby="gameSubject-tab">
                        <div class="modal-body" style="text-align: center;">
                            <label for="nickName_ld">Game Nickname</label>
                            <input type="text" class="form-control" id="nickName_ld" style="background: #2a3942; border: 1px solid #8696a0; color: #e9edef; width: 300px; display: block; margin: 0 auto;" placeholder="Enter your game nickname">
                            <p style="margin-top: 20px;"><strong>Subject Selection:</strong></p>
                            <div class="d-none" id="titleButtonContainer"></div>
                            <div class="d-none" id="subjectButtonContainer"></div>
                            <p id="selectedSubject" style="margin-top: 20px;"></p>
                            <p id="suggestedSubject" style="margin-top: 20px;"></p>
                            <div style="margin-top: 20px;">
                                <label for="maxGameCount">Max Game Count:</label>
                                <input type="number" class="form-control" id="maxGameCount" style="background: #2a3942; border: 1px solid #8696a0; color: #e9edef; width: 100px; display: inline-block;" placeholder="Max count" disabled>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="gameTip" role="tabpanel" aria-labelledby="gameTip-tab">
                        <div class="modal-body">
                            <h5>How to Play</h5>
                            <p>1. The drawer has 30 seconds to draw the given subject.</p>
                            <p>2. To answer, click "Tell Your Answer" button and speak your guess.</p>
                            <h5>Tips</h5>
                            <p>1. Drawing time is limited - use it wisely!</p>
                            <p>2. For voice recognition, just say the answer directly.</p>
                        </div>
                    </div>
                </div>

                <div class="modal-footer" style="border-top: 1px solid #2a3942;">
                    <button class='start-btn btn btn-secondary' id="exitBtn" data-dismiss="modal">EXIT</button>
                    <button class='start-btn btn btn-primary' id="readyBtn" disabled>GAME READY</button>
                    <div id="loadingIndicator" style="display: none;">
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        <span id="loadingUser"></span>
                    </div>
                    <span id="readyUser"></span>
                    <button class='start-btn btn btn-success' id="startBtn" hidden disabled>GAME START</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Request Modal -->
    <div class="modal" id="gameRequestModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content" style="background: #202c33; color: #e9edef;">
                <div class="modal-header" style="border-bottom: 1px solid #2a3942;">
                    <h5 class="modal-title">Join ConvoSync Game</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: #e9edef;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Would you like to join the game?</p>
                    <input type="text" class="form-control" id="nickName_pt" style="background: #2a3942; border: 1px solid #8696a0; color: #e9edef;" placeholder="Enter your game nickname">
                </div>
                <div class="modal-footer" style="border-top: 1px solid #2a3942;">
                    <button type="button" class="btn btn-secondary" id="rejectGameRequest" data-dismiss="modal">No</button>
                    <button type="button" class="btn btn-primary" id="acceptGameRequest">Yes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Results Modal -->
    <div class="modal fade" id="gameResultsModal" tabindex="-1" aria-labelledby="gameResultsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" style="background: #202c33; color: #e9edef;">
                <div class="modal-header" style="border-bottom: 1px solid #2a3942;">
                    <h5 class="modal-title" id="gameResultsModalLabel">ConvoSync Game Results</h5>
                    <span id="totalGameRounds" class="ml-auto"></span>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: #e9edef;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <ul id="gameResultsList" class="list-group"></ul>
                    <ul class="nav nav-tabs" id="languageTabs" role="tablist" style="background: #2a3942;">
                        <li class="nav-item">
                            <a class="nav-link active" id="korean-tab" data-toggle="tab" href="#korean-feedback" role="tab" aria-controls="korean" aria-selected="true" style="color: #e9edef;">한국어</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="english-tab" data-toggle="tab" href="#english-feedback" role="tab" aria-controls="english" aria-selected="false" style="color: #8696a0;">English</a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="korean-feedback" role="tabpanel" aria-labelledby="korean-tab">
                            <div class="feedback-request">
                                <h6>즐겁게 게임을 즐기셨나요?</h6>
                                <p>만약 불편한 점이나 개선이 필요한 점이 있으시다면 아래 연락처로 연락 주시면 더욱 멋지게 개선해서 서비스할 수 있도록 노력하겠습니다.</p>
                                <p>또한 앞으로 더욱 발전하는 ConvoSync 가 되기 위해 기획자, 프론트 엔드 개발자, 디자이너를 모시고 있습니다. 함께 멋진 서비스를 만들어갈 능력자 분들의 많은 연락 부탁드립니다!</p>
                                <p>Email: wkdtpwhs@gmail.com</p>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="english-feedback" role="tabpanel" aria-labelledby="english-tab">
                            <div class="feedback-request">
                                <h6>Did you enjoy ConvoSync?</h6>
                                <p>If there are any inconveniences or improvements needed, please contact us below, and we will make every effort to enhance our service.</p>
                                <p>In addition, as ConvoSync aims to evolve further, we are looking for planners, front-end developers, and designers. We invite all talented individuals interested in building a great service to contact us!</p>
                                <p>Email: wkdtpwhs@gmail.com</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #2a3942;">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Answer Input Modal (Mobile) -->
    <div id="answerInputModal" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content" style="background: #202c33; color: #e9edef;">
                <div class="modal-header" style="border-bottom: 1px solid #2a3942;">
                    <h5 class="modal-title">Enter Answer</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: #e9edef;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control" id="userAnswer" style="background: #2a3942; border: 1px solid #8696a0; color: #e9edef;" placeholder="Enter your answer here">
                </div>
                <div class="modal-footer" style="border-top: 1px solid #2a3942;">
                    <button type="button" class="btn btn-primary" id="submitAnswer">Submit</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Original Scripts (maintaining backend compatibility) -->
    <script src='config/config.js'></script>
    <script src="js/common/common.js"></script>
    <script src="js/common/spinnerOpt.js"></script>
    <script src="js/common/ajaxUtil.js"></script>
    <script src="js/rtc/participant.js"></script>
    <script src="js/rtc/kurento-utils.js"></script>
    <script src="js/popup/popup-loader.js"></script>
    <script src="js/popup/audio_error_popup.js"></script>
    <script src="js/rtc/speechSubtitleManager.js"></script>
    <script src="js/rtc/kurento-service.js"></script>
    <script src="js/rtc/dataChannel.js"></script>
    <script src="js/rtc/dataChannelChatting.js"></script>
    <script src="js/rtc/dataChannelFileUtil.js"></script>
    <script src="js/rtc/mediaDevice.js"></script>
    <script src="js/rtc/catchMind.js"></script>

    <script>
        // WhatsApp UI Enhancement Scripts
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-resize textarea
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 100) + 'px';
                });

                // Send message on Enter (Shift+Enter for new line)
                messageInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        document.getElementById('sendMessage').click();
                    }
                });
            }

            // Mobile responsive sidebar toggle
            const sidebarToggle = document.createElement('button');
            sidebarToggle.className = 'sidebar-toggle d-md-none';
            sidebarToggle.innerHTML = '<i class="fas fa-bars"></i>';
            sidebarToggle.style.cssText = `
                position: fixed;
                top: 10px;
                left: 10px;
                z-index: 1001;
                background: #00a884;
                border: none;
                border-radius: 50%;
                width: 50px;
                height: 50px;
                color: white;
                font-size: 18px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            `;
            
            if (window.innerWidth <= 768) {
                document.body.appendChild(sidebarToggle);
                
                sidebarToggle.addEventListener('click', function() {
                    const sidebar = document.querySelector('.chat-sidebar');
                    sidebar.classList.toggle('active');
                });
            }

            // Update video button states based on data-flag
            const videoBtn = document.getElementById('videoBtn');
            const audioBtn = document.getElementById('audioBtn');
            const subtitleBtn = document.getElementById('subtitleBtn');
            const screenShareBtn = document.getElementById('screenShareBtn');

            function updateButtonState(button, isActive) {
                if (isActive) {
                    button.classList.remove('active');
                } else {
                    button.classList.add('active');
                }
            }

            // Monitor button state changes
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'data-flag') {
                        const button = mutation.target;
                        const isActive = button.getAttribute('data-flag') === 'true';
                        updateButtonState(button, isActive);
                        
                        // Update icon based on state
                        const icon = button.querySelector('i');
                        if (button.id === 'videoBtn') {
                            icon.className = isActive ? 'fas fa-video' : 'fas fa-video-slash';
                        } else if (button.id === 'audioBtn') {
                            icon.className = isActive ? 'fas fa-microphone' : 'fas fa-microphone-slash';
                        } else if (button.id === 'subtitleBtn') {
                            icon.className = isActive ? 'fas fa-closed-captioning' : 'far fa-closed-captioning';
                        } else if (button.id === 'screenShareBtn') {
                            icon.className = isActive ? 'fas fa-desktop' : 'fas fa-laptop';
                        }
                    }
                });
            });

            // Observe all video control buttons
            [videoBtn, audioBtn, subtitleBtn, screenShareBtn].forEach(button => {
                if (button) {
                    observer.observe(button, { attributes: true, attributeFilter: ['data-flag'] });
                }
            });

            // Initialize button states
            if (videoBtn) updateButtonState(videoBtn, videoBtn.getAttribute('data-flag') === 'true');
            if (audioBtn) updateButtonState(audioBtn, audioBtn.getAttribute('data-flag') === 'true');
            if (subtitleBtn) updateButtonState(subtitleBtn, subtitleBtn.getAttribute('data-flag') === 'true');
            if (screenShareBtn) updateButtonState(screenShareBtn, screenShareBtn.getAttribute('data-flag') === 'true');

            // Redirect original floating chat messages to WhatsApp-style interface
            const originalMessagesContainer = document.querySelector('.messages');
            if (originalMessagesContainer) {
                const messagesObserver = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'childList') {
                            mutation.addedNodes.forEach(function(node) {
                                if (node.nodeType === Node.ELEMENT_NODE) {
                                    // Create WhatsApp-style message
                                    createWhatsAppMessage(node.textContent || node.innerText);
                                }
                            });
                        }
                    });
                });
                messagesObserver.observe(originalMessagesContainer, { childList: true });
            }

            // Function to create WhatsApp-style messages
            function createWhatsAppMessage(content, isOwn = false) {
                const videoArea = document.querySelector('.video-area');
                let messagesContainer = document.querySelector('.whatsapp-messages');
                
                if (!messagesContainer) {
                    messagesContainer = document.createElement('div');
                    messagesContainer.className = 'whatsapp-messages';
                    messagesContainer.style.cssText = `
                        position: absolute;
                        bottom: 20px;
                        right: 20px;
                        max-width: 300px;
                        background: rgba(32, 44, 51, 0.9);
                        border-radius: 8px;
                        padding: 10px;
                        max-height: 200px;
                        overflow-y: auto;
                        z-index: 100;
                    `;
                    videoArea.appendChild(messagesContainer);
                }

                const messageDiv = document.createElement('div');
                messageDiv.className = isOwn ? 'message own' : 'message';
                messageDiv.style.cssText = `
                    background: ${isOwn ? '#005c4b' : '#202c33'};
                    color: #e9edef;
                    padding: 8px 12px;
                    border-radius: 8px;
                    margin: 4px 0;
                    max-width: 85%;
                    margin-left: ${isOwn ? 'auto' : '0'};
                    font-size: 14px;
                    word-wrap: break-word;
                `;
                messageDiv.textContent = content;
                
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.remove();
                    }
                }, 5000);
            }

            // Update participant count
            function updateParticipantCount() {
                const participants = document.querySelectorAll('#participants .participant, .video-participant');
                const countElement = document.getElementById('participantCount');
                if (countElement) {
                    countElement.textContent = `${participants.length} participant${participants.length !== 1 ? 's' : ''} in call`;
                }
            }

            // Monitor participants changes
            const participantsContainer = document.getElementById('participants');
            if (participantsContainer) {
                const participantsObserver = new MutationObserver(updateParticipantCount);
                participantsObserver.observe(participantsContainer, { childList: true, subtree: true });
                updateParticipantCount(); // Initial count
            }

            // Handle search functionality
            const searchBox = document.querySelector('.search-box');
            if (searchBox) {
                searchBox.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const chatItems = document.querySelectorAll('.chat-item');
                    
                    chatItems.forEach(item => {
                        const chatName = item.querySelector('.chat-name').textContent.toLowerCase();
                        const chatPreview = item.querySelector('.chat-preview').textContent.toLowerCase();
                        
                        if (chatName.includes(searchTerm) || chatPreview.includes(searchTerm)) {
                            item.style.display = 'flex';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            }

            // Handle window resize
            window.addEventListener('resize', function() {
                const sidebarToggle = document.querySelector('.sidebar-toggle');
                if (window.innerWidth <= 768) {
                    if (!sidebarToggle && !document.querySelector('.sidebar-toggle')) {
                        document.body.appendChild(sidebarToggle);
                    }
                } else {
                    if (sidebarToggle) {
                        sidebarToggle.remove();
                    }
                    document.querySelector('.chat-sidebar').classList.remove('active');
                }
            });

            // Connect original send message functionality to new input
            const originalSendBtn = document.querySelector('#sendMessage');
            const newMessageInput = document.getElementById('messageInput');
            const originalTextBox = document.querySelector('.text-box');

            if (originalSendBtn && newMessageInput && originalTextBox) {
                // Override send button click
                const newSendBtn = document.querySelector('.send-btn');
                newSendBtn.addEventListener('click', function() {
                    const message = newMessageInput.value.trim();
                    if (message) {
                        // Copy message to original text box and trigger send
                        originalTextBox.innerHTML = message;
                        originalTextBox.textContent = message;
                        
                        // Trigger original send functionality
                        originalSendBtn.click();
                        
                        // Clear new input
                        newMessageInput.value = '';
                        newMessageInput.style.height = 'auto';
                        
                        // Show message in WhatsApp style
                        createWhatsAppMessage(message, true);
                    }
                });
            }

            // Theme toggle (optional enhancement)
            function toggleTheme() {
                const root = document.documentElement;
                const isDark = root.style.getPropertyValue('--bg-primary') === '#0b141a';
                
                if (isDark) {
                    // Light theme
                    root.style.setProperty('--bg-primary', '#ffffff');
                    root.style.setProperty('--bg-secondary', '#f0f2f5');
                    root.style.setProperty('--text-primary', '#111b21');
                    root.style.setProperty('--text-secondary', '#667781');
                } else {
                    // Dark theme (default)
                    root.style.setProperty('--bg-primary', '#0b141a');
                    root.style.setProperty('--bg-secondary', '#202c33');
                    root.style.setProperty('--text-primary', '#e9edef');
                    root.style.setProperty('--text-secondary', '#8696a0');
                }
            }

            // Add ConvoSync branding updates
            document.title = 'ConvoSync - Video Chat & Games';
            
            // Update any remaining ChatForYou references
            const titleElements = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
            titleElements.forEach(element => {
                if (element.textContent.includes('ChatForYou')) {
                    element.textContent = element.textContent.replace(/ChatForYou/g, 'ConvoSync');
                }
            });

            // Add status indicators for participants
            function addStatusIndicators() {
                const participants = document.querySelectorAll('.chat-item');
                participants.forEach(participant => {
                    if (!participant.querySelector('.status-indicator')) {
                        const status = document.createElement('div');
                        status.className = 'status-indicator status-online';
                        participant.appendChild(status);
                    }
                });
            }

            // Initialize status indicators
            addStatusIndicators();

            // Update room header with proper styling
            const roomHeader = document.getElementById('room-header');
            if (roomHeader && roomHeader.textContent.trim() === '') {
                roomHeader.textContent = 'ConvoSync Room';
            }
        });

        // Additional compatibility functions
        function maintainBackendCompatibility() {
            // Ensure all original IDs and classes remain accessible
            const hiddenElements = document.querySelectorAll('#container, .floating-chat, .floating-game-canvas');
            hiddenElements.forEach(el => {
                el.style.position = 'absolute';
                el.style.left = '-9999px';
                el.style.visibility = 'hidden';
            });

            // Bridge between new UI and original functionality
            const originalParticipants = document.getElementById('participants');
            if (originalParticipants) {
                // Monitor for participant additions/removals
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'childList') {
                            // Update WhatsApp UI participants list
                            updateWhatsAppParticipants();
                        }
                    });
                });
                observer.observe(originalParticipants, { childList: true, subtree: true });
            }
        }

        function updateWhatsAppParticipants() {
            const originalParticipants = document.querySelectorAll('#participants .participant');
            const sidebarList = document.querySelector('.chat-list');
            
            // Clear existing participant items (keep room chat)
            const existingParticipants = sidebarList.querySelectorAll('.chat-item:not(.room-chat)');
            existingParticipants.forEach(item => item.remove());
            
            // Add current participants
            originalParticipants.forEach((participant, index) => {
                const participantName = participant.getAttribute('data-participant-name') || `User ${index + 1}`;
                const chatItem = createParticipantChatItem(participantName);
                sidebarList.appendChild(chatItem);
            });
        }

        function createParticipantChatItem(name) {
            const chatItem = document.createElement('div');
            chatItem.className = 'chat-item participant-item';
            chatItem.innerHTML = `
                <div class="chat-avatar">
                    ${name.charAt(0).toUpperCase()}
                </div>
                <div class="chat-info">
                    <div class="chat-name">${name}</div>
                    <div class="chat-preview">In video call</div>
                </div>
                <div class="chat-time">now</div>
                <div class="status-indicator status-online"></div>
            `;
            return chatItem;
        }

        // Initialize compatibility layer
        document.addEventListener('DOMContentLoaded', maintainBackendCompatibility);

        // Performance optimization for video rendering
        function optimizeVideoPerformance() {
            const videoElements = document.querySelectorAll('video');
            videoElements.forEach(video => {
                video.style.transform = 'translateZ(0)'; // Hardware acceleration
                video.setAttribute('playsinline', ''); // iOS compatibility
            });
        }

        // Call optimization
        setTimeout(optimizeVideoPerformance, 1000);
    </script>
</body>
</html>