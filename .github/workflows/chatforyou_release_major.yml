name: Release ChatForYou Desktop by major version

on:
  push:
    branches:
      - chatforyou_v2  # ë©”ì¸ ë¸Œëžœì¹˜ ì´ë¦„

jobs:
  bump_major_version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ ì»¤ë°‹ê³¼ íƒœê·¸ ížˆìŠ¤í† ë¦¬ ëª¨ë‘ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ í•„ìš”

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Configure Git User
        run: |
          git config user.name "ChatForYou Release Bot"
          git config user.email "sejon@gmail.com"

      - name: Install dependencies
        run: |
          cd chatforyou-desktop
          npm ci

      - name: Bump major version
        id: bump_version
        run: |
          cd chatforyou-desktop
          # package.jsonì˜ ë©”ì´ì € ë²„ì „ì„ 1 ìƒìŠ¹ì‹œí‚¤ê³ , git ì»¤ë°‹ê³¼ íƒœê·¸ ìžë™ ìƒì„±
          npm version major -m "ChatForYou Electron App Released %s"
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "new_version=v${NEW_VERSION}" >> $GITHUB_OUTPUT

      - name: Push commit and tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ë©”ì´ì € ë²„ì „ ì˜¬ë¼ê°„ ì»¤ë°‹ê³¼ ìƒì„±ëœ íƒœê·¸ë¥¼ ì›ê²© ì €ìž¥ì†Œì— í‘¸ì‹œ
          git push origin chatforyou_v2
          git push origin ${{ steps.bump_version.outputs.new_version }}

  build_and_release:
    needs: bump_major_version
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        include:
          - os: macos-latest
            platform: mac
            build-script: build:mac
            artifact-name: macos-build
            artifact-pattern: |
              chatforyou-desktop/dist/*.dmg
              chatforyou-desktop/dist/*.dmg.blockmap
              chatforyou-desktop/dist/latest-mac.yml
          - os: windows-latest
            platform: win
            build-script: build:win
            artifact-name: windows-build
            artifact-pattern: |
              chatforyou-desktop/dist/*.exe
              chatforyou-desktop/dist/*.exe.blockmap
              chatforyou-desktop/dist/latest.yml
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: chatforyou_v2  # ìµœì‹  ì»¤ë°‹ì„ ê°€ì ¸ì˜¤ê¸° ìœ„í•´
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: chatforyou-desktop/package-lock.json
        
    - name: Install dependencies
      run: |
        cd chatforyou-desktop
        npm ci
        
    - name: Build Electron app (í†µí•© ë¹Œë“œ ì‹œìŠ¤í…œ)
      run: |
        cd chatforyou-desktop
        npm run ${{ matrix.build-script }}
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        CSC_IDENTITY_AUTO_DISCOVERY: false
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact-name }}
        path: ${{ matrix.artifact-pattern }}
        retention-days: 7

  create_release:
    needs: [bump_major_version, build_and_release]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: chatforyou_v2
        fetch-depth: 0  # íƒœê·¸ ížˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´
      
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Get version from package.json
      id: get_version
      run: |
        cd chatforyou-desktop
        VERSION="v$(node -p "require('./package.json').version")"
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "version_number=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
      
    - name: Generate Release Notes
      id: release_notes
      run: |
        # ì´ì „ íƒœê·¸ì™€ í˜„ìž¬ íƒœê·¸ ì‚¬ì´ì˜ ì»¤ë°‹ë“¤ë¡œë¶€í„° ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
        CURRENT_TAG="${{ steps.get_version.outputs.version }}"
        PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -v "$CURRENT_TAG" | head -n 1)
        
        echo "Current tag: $CURRENT_TAG"
        echo "Previous tag: $PREVIOUS_TAG"
        
        if [ -z "$PREVIOUS_TAG" ]; then
          echo "No previous tag found, using recent commits"
          COMMITS=$(git log --pretty=format:"- %s (%h)" --reverse -10)
        else
          echo "Getting commits between $PREVIOUS_TAG and HEAD"
          COMMITS=$(git log --pretty=format:"- %s (%h)" --reverse "$PREVIOUS_TAG..HEAD")
        fi
        
        # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
        cat > release_notes.md << 'EOF'
        ## ðŸŽ‰ ChatForYou ${{ steps.get_version.outputs.version }} ë©”ì´ì € ë¦´ë¦¬ìŠ¤
        
        ### ðŸ“ ë³€ê²½ì‚¬í•­
        
        EOF
        
        if [ -n "$COMMITS" ]; then
          echo "$COMMITS" >> release_notes.md
        else
          echo "- ë©”ì´ì € ë²„ì „ ì—…ë°ì´íŠ¸ ë° ê¸°ëŠ¥ ê°œì„ " >> release_notes.md
        fi
        
        cat >> release_notes.md << 'EOF'
        
        ## ðŸ“¥ ë‹¤ìš´ë¡œë“œ
        
        | í”Œëž«í¼ | íŒŒì¼ | ì„¤ëª… |
        |--------|------|------|
        | macOS (Apple Silicon) | ChatForYou-${{ steps.get_version.outputs.version_number }}-arm64.dmg | Apple M1/M2 Macìš© |
        | macOS (Intel) | ChatForYou-${{ steps.get_version.outputs.version_number }}.dmg | Intel Macìš© |
        | Windows | ChatForYou-Setup-${{ steps.get_version.outputs.version_number }}.exe | Windows 10/11 64-bit |
        
        ## ðŸš€ ì„¤ì¹˜ ë°©ë²•
        
        ### macOS
        1. í•´ë‹¹í•˜ëŠ” DMG íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤
        2. DMG íŒŒì¼ì„ ì—´ê³  ChatForYou ì•„ì´ì½˜ì„ Applications í´ë”ë¡œ ë“œëž˜ê·¸í•©ë‹ˆë‹¤
        3. Launchpad ë˜ëŠ” Applications í´ë”ì—ì„œ ChatForYouë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤
        
        ### Windows
        1. Setup.exe íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤
        2. íŒŒì¼ì„ ì‹¤í–‰í•˜ê³  ì„¤ì¹˜ ë§ˆë²•ì‚¬ë¥¼ ë”°ë¼ ì§„í–‰í•©ë‹ˆë‹¤
        3. ë°”íƒ•í™”ë©´ ë˜ëŠ” ì‹œìž‘ ë©”ë‰´ì—ì„œ ChatForYouë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤
        
        ## ðŸ”„ ìžë™ ì—…ë°ì´íŠ¸
        
        ì•±ì´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìžë™ìœ¼ë¡œ ìƒˆ ë²„ì „ì„ í™•ì¸í•˜ê³ , ì—…ë°ì´íŠ¸ê°€ ìžˆì„ ë•Œ ì•Œë¦¼ì„ í‘œì‹œí•©ë‹ˆë‹¤.
        
        ## ðŸ“ž ì§€ì›
        
        ë¬¸ì œê°€ ë°œìƒí•˜ê±°ë‚˜ ê¸°ëŠ¥ ìš”ì²­ì´ ìžˆìœ¼ì‹œë©´ [GitHub Issues](https://github.com/SeJonJ/ChatForYou/issues)ì— ì•Œë ¤ì£¼ì„¸ìš”!
        
        EOF
        
        # multiline outputì„ ìœ„í•œ EOF delimiter ì„¤ì •
        {
          echo 'release_body<<EOF'
          cat release_notes.md
          echo 'EOF'
        } >> $GITHUB_OUTPUT
        
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        name: ChatForYou ${{ steps.get_version.outputs.version }} (Major Release)
        body: ${{ steps.release_notes.outputs.release_body }}
        draft: false
        prerelease: false
        files: |
          macos-build/*.dmg
          macos-build/*.dmg.blockmap
          macos-build/latest-mac.yml
          windows-build/*.exe
          windows-build/*.exe.blockmap
          windows-build/latest.yml
        fail_on_unmatched_files: false
