name: Release ChatForYou Desktop by tag

on:
  push:
    tags:
      - 'v*.*.*'  # v1.0.0, v1.0.1 ë“±ì˜ íƒœê·¸ê°€ pushë  ë•Œ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  build:
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        include:
          - os: macos-latest
            platform: mac
            build-script: build:mac
            artifact-name: macos-build
            artifact-pattern: |
              chatforyou-desktop/dist/*.dmg
              chatforyou-desktop/dist/*.dmg.blockmap
              chatforyou-desktop/dist/*.zip
              chatforyou-desktop/dist/*.zip.blockmap
              chatforyou-desktop/dist/latest-mac.yml
          - os: windows-latest
            platform: win
            build-script: build:win
            artifact-name: windows-build
            artifact-pattern: |
              chatforyou-desktop/dist/*.exe
              chatforyou-desktop/dist/*.exe.blockmap
              chatforyou-desktop/dist/latest.yml
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: chatforyou-desktop/package-lock.json
        
    - name: Install dependencies
      run: |
        cd chatforyou-desktop
        npm ci
        
    - name: Build Electron app (í†µí•© ë¹Œë“œ ì‹œìŠ¤í…œ)
      run: |
        cd chatforyou-desktop
        npm run ${{ matrix.build-script }}
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        CSC_IDENTITY_AUTO_DISCOVERY: false
        
    - name: Sign macOS ZIP contents (for macOS)
      if: matrix.platform == 'mac'
      run: |
        cd chatforyou-desktop
        # Find and sign all .app bundles in ZIP files
        for zipfile in dist/*.zip; do
          if [ -f "$zipfile" ]; then
            echo "Processing ZIP file: $zipfile"
            # Create temp directory
            temp_dir=$(mktemp -d)
            # Extract ZIP
            unzip -q "$zipfile" -d "$temp_dir"
            # Find .app bundles and sign them
            find "$temp_dir" -name "*.app" -type d | while read -r app_path; do
              echo "Signing app: $app_path"
              codesign --force --deep --sign - "$app_path"
              codesign --verify --verbose "$app_path"
            done
            # Re-create ZIP with signed apps
            cd "$temp_dir"
            zip -r -q "../$(basename "$zipfile")" .
            cd - > /dev/null
            mv "$temp_dir/../$(basename "$zipfile")" "$zipfile"
            # Cleanup
            rm -rf "$temp_dir"
            echo "Re-signed ZIP: $zipfile"
            
            # Update SHA512 checksum in latest-mac.yml
            if [ -f "dist/latest-mac.yml" ]; then
              echo "Updating SHA512 checksum for $(basename "$zipfile")"
              # ì˜¬ë°”ë¥¸ ë°©ë²•: hexë¥¼ ë°”ì´ë„ˆë¦¬ë¡œ ë³€í™˜ í›„ base64 ì¸ì½”ë”©
              new_sha512_hex=$(shasum -a 512 "$zipfile" | cut -d' ' -f1)
              new_sha512=$(echo -n "$new_sha512_hex" | xxd -r -p | base64)
              new_size=$(stat -f%z "$zipfile" 2>/dev/null || stat -c%s "$zipfile")
              
              echo "Original file: $zipfile"
              echo "SHA512 hex: $new_sha512_hex"
              echo "SHA512 base64: $new_sha512"
              echo "File size: $new_size"
              
              # YAML íŒŒì¼ì„ ì •í™•í•˜ê²Œ ì—…ë°ì´íŠ¸
              zip_filename=$(basename "$zipfile")
              
              # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
              export ZIP_FILENAME="$zip_filename"
              export NEW_SHA512="$new_sha512"
              export NEW_SIZE="$new_size"
              
              # Pythonì„ ì‚¬ìš©í•´ YAMLì„ ì •í™•íˆ ì—…ë°ì´íŠ¸
              python3 << EOF
import yaml
import sys
import os

try:
    yml_path = 'dist/latest-mac.yml'
    with open(yml_path, 'r') as f:
        content = f.read()
    
    print(f"Original YAML content:")
    print(content)
    
    # YAML íŒŒì‹±
    data = yaml.safe_load(content)
    
    # í™˜ê²½ë³€ìˆ˜ì—ì„œ ê°’ ì½ê¸°
    zip_filename = os.environ.get('ZIP_FILENAME', '')
    new_sha512 = os.environ.get('NEW_SHA512', '')
    new_size = int(os.environ.get('NEW_SIZE', '0'))
    
    print(f"ZIP filename: {zip_filename}")
    print(f"New SHA512: {new_sha512}")
    print(f"New size: {new_size}")
    
    # files ë°°ì—´ì—ì„œ í•´ë‹¹ ZIP íŒŒì¼ ì°¾ê¸°
    if 'files' in data:
        for file_info in data['files']:
            if 'url' in file_info and file_info['url'].endswith(zip_filename):
                print(f"Updating file: {file_info['url']}")
                file_info['sha512'] = new_sha512
                file_info['size'] = new_size
                print(f"New sha512: {file_info['sha512']}")
                print(f"New size: {file_info['size']}")
    
    # ì—…ë°ì´íŠ¸ëœ YAML ì €ì¥
    with open(yml_path, 'w') as f:
        yaml.dump(data, f, default_flow_style=False, sort_keys=False)
    
    print("YAML file updated successfully")
    
except Exception as e:
    print(f"Error: {e}")
    print("Falling back to sed replacement")
    # Fallback with environment variables
    import subprocess
    sed_sha512_cmd = f'sed -i.bak "s/sha512: .*/sha512: {new_sha512}/" dist/latest-mac.yml'
    sed_size_cmd = f'sed -i.bak "s/size: .*/size: {new_size}/" dist/latest-mac.yml'
    subprocess.run(sed_sha512_cmd, shell=True)
    subprocess.run(sed_size_cmd, shell=True)
    subprocess.run('rm -f dist/latest-mac.yml.bak', shell=True)
EOF
              
              echo "Updated latest-mac.yml"
            fi
          fi
        done
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact-name }}
        path: ${{ matrix.artifact-pattern }}
        retention-days: 7
          
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Get version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT
      
    - name: List downloaded files (debug)
      run: |
        echo "Downloaded artifacts:"
        find . -type f -name "*.dmg" -o -name "*.exe" -o -name "*.AppImage" -o -name "*.yml" | sort
        
    - name: Generate Release Notes
      id: release_notes
      run: |
        # ì´ì „ íƒœê·¸ì™€ í˜„ì¬ íƒœê·¸ ì‚¬ì´ì˜ ì»¤ë°‹ë“¤ë¡œë¶€í„° ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
        CURRENT_TAG="${{ steps.get_version.outputs.version }}"
        PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -v "$CURRENT_TAG" | head -n 1)
        
        echo "Current tag: $CURRENT_TAG"
        echo "Previous tag: $PREVIOUS_TAG"
        
        if [ -z "$PREVIOUS_TAG" ]; then
          echo "No previous tag found, using all commits"
          COMMITS=$(git log --pretty=format:"- %s (%h)" --reverse)
        else
          echo "Getting commits between $PREVIOUS_TAG and $CURRENT_TAG"
          COMMITS=$(git log --pretty=format:"- %s (%h)" --reverse "$PREVIOUS_TAG..$CURRENT_TAG")
        fi
        
        # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
        cat > release_notes.md << 'EOF'
        ## ğŸ‰ ChatForYou ${{ steps.get_version.outputs.version }} ë¦´ë¦¬ìŠ¤
        
        ### ğŸ“ ë³€ê²½ì‚¬í•­
        
        EOF
        
        if [ -n "$COMMITS" ]; then
          echo "$COMMITS" >> release_notes.md
        else
          echo "- ë²„ê·¸ ìˆ˜ì • ë° ì„±ëŠ¥ ê°œì„ " >> release_notes.md
        fi
        
        cat >> release_notes.md << 'EOF'
        
        ## ğŸ“¥ ë‹¤ìš´ë¡œë“œ
        
        | í”Œë«í¼ | íŒŒì¼ | ì„¤ëª… |
        |--------|------|------|
        | macOS (Apple Silicon) | ChatForYou-${{ steps.get_version.outputs.version_number }}-arm64.dmg | Apple M1/M2 Macìš© |
        | macOS (Intel) | ChatForYou-${{ steps.get_version.outputs.version_number }}.dmg | Intel Macìš© |
        | Windows | ChatForYou-Setup-${{ steps.get_version.outputs.version_number }}.exe | Windows 10/11 64-bit |
        
        ## ğŸš€ ì„¤ì¹˜ ë°©ë²•
        
        ### macOS
        1. í•´ë‹¹í•˜ëŠ” DMG íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤
        2. DMG íŒŒì¼ì„ ì—´ê³  ChatForYou ì•„ì´ì½˜ì„ Applications í´ë”ë¡œ ë“œë˜ê·¸í•©ë‹ˆë‹¤
        3. Launchpad ë˜ëŠ” Applications í´ë”ì—ì„œ ChatForYouë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤
        
        âš ï¸ **macOS "ì†ìƒëœ íŒŒì¼" ì—ëŸ¬ í•´ê²° ë°©ë²•**

        macOSì—ì„œ "ì†ìƒëœ íŒŒì¼"ì´ë¼ëŠ” ì—ëŸ¬ê°€ ë°œìƒí•  ê²½ìš°:
        
        **ë°©ë²• 1: ìš°í´ë¦­ìœ¼ë¡œ ì—´ê¸°**
        1. ChatForYou ì•±ì„ ìš°í´ë¦­ â†’ "ì—´ê¸°" ì„ íƒ
        2. ê²½ê³  ëŒ€í™”ìƒìì—ì„œ "ì—´ê¸°" í´ë¦­
        
        **ë°©ë²• 2: í„°ë¯¸ë„ ëª…ë ¹ì–´ (ê¶Œì¥)**
        ```bash
        # ë‹¤ìš´ë¡œë“œí•œ DMG íŒŒì¼ì˜ quarantine ì†ì„± ì œê±°
        xattr -r -d com.apple.quarantine ~/Downloads/ChatForYou-*.dmg
        
        # ë˜ëŠ” ì„¤ì¹˜ëœ ì•±ì˜ quarantine ì†ì„± ì œê±°
        xattr -r -d com.apple.quarantine /Applications/ChatForYou.app
        ```
        
        **ì™œ ì´ëŸ° ì—ëŸ¬ê°€ ë°œìƒí•˜ë‚˜ìš”?**
        - macOS GatekeeperëŠ” Apple ê°œë°œì ì¸ì¦ì„œë¡œ ì„œëª…ë˜ì§€ ì•Šì€ ì•±ì„ ìë™ìœ¼ë¡œ ì°¨ë‹¨í•©ë‹ˆë‹¤
        - ChatForYouëŠ” ê°œì¸ í”„ë¡œì íŠ¸ë¡œ Apple Developer Programì— ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤
        - ì´ëŠ” macOSë§Œì˜ ë³´ì•ˆ ì •ì±…ìœ¼ë¡œ, Windowsì—ì„œëŠ” ë°œìƒí•˜ì§€ ì•ŠëŠ” ë¬¸ì œì…ë‹ˆë‹¤
        
        ### Windows
        1. Setup.exe íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤
        2. íŒŒì¼ì„ ì‹¤í–‰í•˜ê³  ì„¤ì¹˜ ë§ˆë²•ì‚¬ë¥¼ ë”°ë¼ ì§„í–‰í•©ë‹ˆë‹¤
        3. ë°”íƒ•í™”ë©´ ë˜ëŠ” ì‹œì‘ ë©”ë‰´ì—ì„œ ChatForYouë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤
        
        ## ğŸ”„ ìë™ ì—…ë°ì´íŠ¸
        
        ì•±ì´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìë™ìœ¼ë¡œ ìƒˆ ë²„ì „ì„ í™•ì¸í•˜ê³ , ì—…ë°ì´íŠ¸ê°€ ìˆì„ ë•Œ ì•Œë¦¼ì„ í‘œì‹œí•©ë‹ˆë‹¤.
        
        ## ğŸ“ ì§€ì›
        
        ë¬¸ì œê°€ ë°œìƒí•˜ê±°ë‚˜ ê¸°ëŠ¥ ìš”ì²­ì´ ìˆìœ¼ì‹œë©´ [GitHub Issues](https://github.com/SeJonJ/ChatForYou/issues)ì— ì•Œë ¤ì£¼ì„¸ìš”!
        
        EOF
        
        # multiline outputì„ ìœ„í•œ EOF delimiter ì„¤ì •
        {
          echo 'release_body<<EOF'
          cat release_notes.md
          echo 'EOF'
        } >> $GITHUB_OUTPUT
        
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        name: ChatForYou ${{ steps.get_version.outputs.version }}
        body: ${{ steps.release_notes.outputs.release_body }}
        draft: false
        prerelease: false
        files: |
          macos-build/*.dmg
          macos-build/*.dmg.blockmap
          macos-build/*.zip
          macos-build/*.zip.blockmap
          macos-build/latest-mac.yml
          windows-build/*.exe
          windows-build/*.exe.blockmap
          windows-build/latest.yml
        fail_on_unmatched_files: false