name: Release ChatForYou Desktop by tag

on:
  push:
    tags:
      - 'v*.*.*'  # v1.0.0, v1.0.1 등의 태그가 push될 때 실행
  workflow_dispatch:  # 수동 실행도 가능

jobs:
  build:
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        include:
          - os: macos-latest
            platform: mac
            build-script: build:mac
            artifact-name: macos-build
            artifact-pattern: |
              chatforyou-desktop/dist/*.dmg
              chatforyou-desktop/dist/*.dmg.blockmap
              chatforyou-desktop/dist/latest-mac.yml
          - os: windows-latest
            platform: win
            build-script: build:win
            artifact-name: windows-build
            artifact-pattern: |
              chatforyou-desktop/dist/*.exe
              chatforyou-desktop/dist/*.exe.blockmap
              chatforyou-desktop/dist/latest.yml
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: chatforyou-desktop/package-lock.json
        
    - name: Install dependencies
      run: |
        cd chatforyou-desktop
        npm ci
        
    - name: Build Electron app (통합 빌드 시스템)
      run: |
        cd chatforyou-desktop
        npm run ${{ matrix.build-script }}
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact-name }}
        path: ${{ matrix.artifact-pattern }}
        retention-days: 7
          
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Get version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT
      
    - name: List downloaded files (debug)
      run: |
        echo "Downloaded artifacts:"
        find . -type f -name "*.dmg" -o -name "*.exe" -o -name "*.AppImage" -o -name "*.yml" | sort
        
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        name: ChatForYou ${{ steps.get_version.outputs.version }}
        body: |
          ## 🎉 ChatForYou ${{ steps.get_version.outputs.version }} 릴리스
          
          ## 📥 다운로드
          
          | 플랫폼 | 파일 | 설명 |
          |--------|------|------|
          | macOS (Apple Silicon) | ChatForYou-${{ steps.get_version.outputs.version_number }}-arm64.dmg | Apple M1/M2 Mac용 |
          | macOS (Intel) | ChatForYou-${{ steps.get_version.outputs.version_number }}.dmg | Intel Mac용 |
          | Windows | ChatForYou-Setup-${{ steps.get_version.outputs.version_number }}.exe | Windows 10/11 64-bit |
          
          ## 🚀 설치 방법
          
          ### macOS
          1. 해당하는 DMG 파일을 다운로드합니다
          2. DMG 파일을 열고 ChatForYou 아이콘을 Applications 폴더로 드래그합니다
          3. Launchpad 또는 Applications 폴더에서 ChatForYou를 실행합니다
          
          ### Windows
          1. Setup.exe 파일을 다운로드합니다
          2. 파일을 실행하고 설치 마법사를 따라 진행합니다
          3. 바탕화면 또는 시작 메뉴에서 ChatForYou를 실행합니다
          
          ## 🔄 자동 업데이트
          
          앱이 백그라운드에서 자동으로 새 버전을 확인하고, 업데이트가 있을 때 알림을 표시합니다.
          
          ## 📞 지원
          
          문제가 발생하거나 기능 요청이 있으시면 [GitHub Issues](https://github.com/SeJonJ/ChatForYou/issues)에 알려주세요!
          
        draft: false
        prerelease: false
        files: |
          macos-build/*.dmg
          macos-build/*.dmg.blockmap
          macos-build/latest-mac.yml
          windows-build/*.exe
          windows-build/*.exe.blockmap
          windows-build/latest.yml
        fail_on_unmatched_files: false